<ion-content [fullscreen]="true">
  <app-header title="Citas"></app-header>
  <div class="ion-page" id="main-content">
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-menu-button></ion-menu-button>
        </ion-buttons>
        <ion-title>{{ "citas.titulo" | translate }}</ion-title>

        <!-- Contenido centrado -->
        <div slot="primary" class="fecha-wrapper">
          <ion-item lines="none">
            <ion-label position="stacked">{{ "citas.modal.fecha" | translate }}</ion-label>
            <ion-input [(ngModel)]="dataSelec" type="date" placeholder="Fecha"
              (ngModelChange)="cargar_dia_seleccionado()">
            </ion-input>
          </ion-item>
        </div>
        <ion-select slot="end" [(ngModel)]="selectedLanguage" (ionChange)="changeLanguage()">
          <ion-select-option value="es">Español</ion-select-option>
          <ion-select-option value="eu">Euskera</ion-select-option>
        </ion-select>
      </ion-toolbar>
      <ion-toolbar class="Headeraaa">
        <ion-segment>
          <ion-segment-button value="ZitaMenua" content-id="ZitaMenua">
            <ion-label>{{ "ikaslePage.taldeenKudeaketa" | translate }} </ion-label>
          </ion-segment-button>
          <ion-segment-button value="Busquedas" content-id="Busquedas">
            <ion-label>{{ "ikaslePage.ordutegienKudeaketa" | translate }} </ion-label>
          </ion-segment-button>
        </ion-segment>
      </ion-toolbar>
    </ion-header>
    <ion-segment-view>
      <ion-segment-content id="ZitaMenua">
        <div class="flexbox">
          <div>
            <div class="table-container">
              <table class="h-100 w-100" *ngIf="!loading">
                <thead>
                  <tr>
                    <th style="background-color: rgba(18, 107, 196, 0.685);">{{ "citas.horas" | translate }}</th>
                    <th *ngFor="let i of [].constructor(asientos); let idx = index"
                      style="background-color: rgba(18, 107, 196, 0.685);">
                      {{ "citas.asientos" | translate }} {{ idx + 1 }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngIf="asientos === 0">
                    <tr>
                      <td colspan="100%" class="text-center">
                        <ion-text color="danger">
                          <p>{{ "citas.modal.vacio" | translate }}</p>
                        </ion-text>
                      </td>
                    </tr>
                  </ng-container>
                  <ng-container *ngIf="asientos > 0">
                    <tr *ngFor="let time of hoursArray">
                      <td style="background-color: rgba(18, 107, 196, 0.685);">{{ time }}</td>
                      <ng-container *ngFor="let i of [].constructor(asientos); let idx = index">
                        <td id="{{ 'time-' + time + '-seat-' + (idx + 1) }}" *ngIf="citaSartuta(time, idx + 1)"
                          [attr.rowspan]="rowspanManagement(time, idx + 1)"
                          [ngClass]="{ 'highlighted': isCellHighlighted(time, idx + 1) }"
                          (dragover)="onDragOver($event)" (drop)="onDrop($event, time, idx + 1)">
                          <ng-container *ngIf="getCitasAtTimeAndSeat(time, idx + 1).length > 0; else emptySeat">
                            <ion-card *ngFor="let cita of getCitasAtTimeAndSeat(time, idx + 1)"
                              (click)="abrirFormularioEdicion(cita)" [ngClass]="{
                                'bg-rojo': cita.prezioTotala,
                                'bg-naranja': cita.langilea && !cita.prezioTotala,
                                'bg-azul': !cita.langilea && !cita.prezioTotala,
                                'selected': cita.id === citaEditar.id
                              }" [attr.id]="'card-' + cita.id" draggable="true"
                              (dragstart)="!cita.prezioTotala && !cita.langilea && onDragStart($event, cita)">
                              <ion-card-header>
                                <ion-card-title>{{ cita.izena }}</ion-card-title>
                              </ion-card-header>
                              <ion-card-content>{{ cita.deskribapena }}</ion-card-content>
                            </ion-card>
                          </ng-container>
                          <ng-template #emptySeat>
                            <ion-button (click)="reservar_cita(idx + 1, time)">
                              <ion-icon name="add-circle-outline"></ion-icon>
                            </ion-button>
                          </ng-template>
                        </td>
                      </ng-container>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
          </div>
          <div>
            <ion-modal [isOpen]="mostrarFormulario" (didDismiss)="cerrarFormulario()" [backdropDismiss]="false"
              cssClass="modal-grande">
              <ng-template>
                <ion-header>
                  <ion-toolbar>
                    <ion-title>{{ 'citas.modal.gestionar' | translate }}</ion-title>
                    <ion-buttons slot="end">
                      <ion-button (click)="cerrarFormulario()">
                        <ion-icon name="close"></ion-icon>
                      </ion-button>
                    </ion-buttons>
                  </ion-toolbar>
                </ion-header>

                <ion-content class="ion-padding">
                  <!-- Segment selector -->
                  <ion-segment [(ngModel)]="segmentoActivo">
                    <ion-segment-button value="editatu">
                      <ion-label>{{ "citas.botones.editar" | translate }}</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="asignatu">
                      <ion-label>{{ "citas.botones.asignar" | translate }}</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="ticket">
                      <ion-label>{{ "citas.botones.generar" | translate }}</ion-label>
                    </ion-segment-button>
                  </ion-segment>

                  <div *ngIf="segmentoActivo === 'editatu'">
                    <form #editCitaForm="ngForm" (ngSubmit)="editar_cita()" novalidate>
                  
                      <!-- Selección de Cliente -->
                      <ion-item>
                        <ion-label position="stacked">Cliente</ion-label>
                        <ion-select [(ngModel)]="citaEditar.telefonoa" name="telefonoa" (ionChange)="cambiarCliente($event)" interface="popover">
                          <ion-select-option *ngFor="let cliente of bezeroak" [value]="cliente.telefonoa">
                            {{ cliente.izena }} - {{ cliente.abizena }}
                          </ion-select-option>
                        </ion-select>
                      </ion-item>
                  
                      <!-- CAMPOS SOLO INFORMATIVOS -->
                      <ion-item>
                        <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
                        <ion-label>{{ "citas.modal.fecha" | translate }}</ion-label>
                        <ion-text>{{ citaEditar.data || '-' }}</ion-text>
                      </ion-item>
                  
                      <ion-item >
                        <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
                        <ion-label>{{ "citas.modal.horaInicio" | translate }}</ion-label>
                        <ion-text>{{ citaEditar.hasieraOrdua || '-' }}</ion-text>
                      </ion-item>
                  
                      <ion-item>
                        <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
                        <ion-label>{{ "citas.modal.horaFin" | translate }}</ion-label>
                        <ion-text>{{ citaEditar.amaieraOrdua || '-' }}</ion-text>
                      </ion-item>
                  
                      <ion-item>
                        <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
                        <ion-label>{{ "citas.modal.asiento" | translate }}</ion-label>
                        <ion-text>{{ citaEditar.eserlekua !== null ? citaEditar.eserlekua : '-' }}</ion-text>
                      </ion-item>
                  
                      <ion-item>
                        <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
                        <ion-label>{{ "citas.modal.cliente" | translate }}</ion-label>
                        <ion-text>{{ citaEditar.izena || '-' }}</ion-text>
                      </ion-item>
                  
                      <ion-item>
                        <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
                        <ion-label>{{ "citas.modal.telefono" | translate }}</ion-label>
                        <ion-text>{{ citaEditar.telefonoa || '-' }}</ion-text>
                      </ion-item>
                  
                      <!-- CAMPOS EDITABLES -->
                      <ion-item>
                        <ion-label position="stacked">{{ "citas.modal.descripcion" | translate }}</ion-label>
                        <ion-input [(ngModel)]="citaEditar.deskribapena" name="descripcion" required #descripcion="ngModel"></ion-input>
                      </ion-item>
                      <ion-text color="danger" *ngIf="descripcion.invalid && descripcion.touched">
                        {{ "citas.validaciones.descripcion" | translate }}
                      </ion-text>
                      <ion-item>
                        <ion-label>{{ "citas.modal.casa" | translate }}</ion-label>
                        <ion-checkbox [(ngModel)]="citaEditar.etxekoa" name="casa" required #casa="ngModel"></ion-checkbox>
                      </ion-item>
                      <ion-text color="danger" *ngIf="casa.invalid && casa.touched">
                        {{ "citas.validaciones.seleccion" | translate }}
                      </ion-text>
                  
                      <!-- BOTONES -->
                      <div class="ion-text-center ion-padding">
                        <ion-button type="submit" (click)="editar_cita()" [disabled]="editCitaForm.invalid || (citaEditar.langilea && !citaEditar.prezioTotala)">
                          {{ "citas.botones.guardar" | translate }}
                        </ion-button>
                        <ion-button color="danger" (click)="eliminar_cita()" [disabled]="editCitaForm.invalid || (citaEditar.langilea && !citaEditar.prezioTotala)">
                          {{ "citas.botones.borrar" | translate }}
                        </ion-button>
                      </div>
                  
                    </form>
                  </div>
                  
                  

                  <div *ngIf="segmentoActivo === 'asignatu'">
                    <!-- Formulario para asignar cita -->
                    <form #asignarCitaForm="ngForm" (ngSubmit)="asignar_cita()" (ngSubmit)="asignarCitaForm.resetForm()"
                      novalidate>
                      <ion-text color="danger" *ngIf="!citaValida()">{{ "citas.validaciones.selectCita" | translate
                        }}</ion-text>
                      <ion-item>
                        <ion-label position="stacked">{{ "citas.modal.trabajador" | translate }}</ion-label>
                        <ion-select [(ngModel)]="idLangile" name="trabajador" placeholder="Seleccione un responsable"
                          required #trabajador="ngModel">
                          <ion-select-option *ngFor="let ikasle of langileArray" [value]="ikasle.id">
                            {{ ikasle.izena }} {{ ikasle.abizena }}
                          </ion-select-option>
                        </ion-select>
                      </ion-item>
                      <ion-button type="submit"
                        [disabled]="asignarCitaForm.invalid || !citaValida() || citaEditar.prezioTotala">
                        {{ "citas.botones.asignar" | translate }}
                      </ion-button>
                    </form>
                  </div>

                  <div *ngIf="segmentoActivo === 'ticket'">
                    <!-- Formulario para generar ticket -->
                    <form #ticketForm="ngForm" (ngSubmit)="generar_ticket()" (ngSubmit)="ticketForm.resetForm()"
                      novalidate>
                      <ion-text color="danger" *ngIf="!citaValida()">{{ "citas.validaciones.selectCita" | translate
                        }}</ion-text>
                      <ion-list *ngFor="let katTrat of tratamenduArray">
                        <ion-label>{{ katTrat.izena }}</ion-label>
                        <ion-item *ngFor="let trat of katTrat.zerbitzuak">
                          <ion-checkbox slot="start" [(ngModel)]="trat.selected" name="trat_{{trat.id}}"
                            (ionChange)="actualizarServiciosSeleccionados(trat, katTrat.extra, katTrat.kolorea)">
                          </ion-checkbox>
                          <ion-label>{{ trat.izena }}</ion-label>
                        </ion-item>
                      </ion-list>
                      <ion-button type="submit" [disabled]="ticketForm.invalid || !citaValida()">
                        {{ "citas.botones.generar" | translate }}
                      </ion-button>
                    </form>
                  </div>
                </ion-content>
              </ng-template>
            </ion-modal>
          </div>
        </div>
      </ion-segment-content>
      <ion-segment-content id="Busquedas">
        <!-- Barra de búsqueda -->
        <div class="busqueda-container">
          <input type="text" class="form-control"
            placeholder="Buscar por cliente, langile, servicio, tratamiento o asiento" [(ngModel)]="filtroBusqueda"
            (input)="filtrarCitas()" />
        </div>
        <ion-list>
          <ion-item *ngFor="let cita of hitzorduArrayFiltrado">
            <ion-card (click)="abrirFormularioEdicion(cita)" class="alargada-card">
              <ion-card-header>
                <ion-card-title>{{ cita.izena }} {{ cita.abizena }}</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <div><strong>Teléfono:</strong> {{ cita.telefonoa }}</div>
                <div><strong>Trabajador:</strong> {{ cita.langilea?.izena || '—' }}</div>
                <div><strong>Servicios:</strong>
                  <ul>
                    <li *ngFor="let s of cita.zerbitzuak">{{ s.izena }}</li>
                  </ul>
                </div>
                <div><strong>Tratamiento:</strong>
                  <span class="badge" [ngClass]="cita.etxekoa === 'E' ? 'badge-primary' : 'badge-secondary'">
                    {{ cita.etxekoa === 'E' ? 'Etxekoa' : 'Kanpokoa' }}
                  </span>
                </div>
                <div><strong>Asiento:</strong> {{ cita.eserlekua }}</div>
                <div><strong>Hora inicio:</strong> {{ cita.hasieraOrdua }}</div>
                <div><strong>Hora fin:</strong> {{ cita.amaieraOrdua }}</div>
              </ion-card-content>
            </ion-card>
          </ion-item>
        </ion-list>
        <!-- Mensaje cuando no hay citas -->
        <ion-text color="danger" *ngIf="hitzorduArrayFiltrado.length === 0">
          <p>{{ "citas.validaciones.noResults" | translate }}</p>
        </ion-text>
      </ion-segment-content>
    </ion-segment-view>
  </div>
</ion-content>